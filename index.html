<!DOCTYPE html>
<html lang="ko">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <style>
        :root { --primary: #1a73e8; --border: #dadce0; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background: #f8f9fa; padding: 15px; margin: 0; color: #3c4043; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(60,64,67,0.3); }
        
        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary); padding-bottom: 15px; }
        .room-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab { padding: 10px 20px; background: #e8f0fe; border-radius: 25px; cursor: pointer; white-space: nowrap; font-size: 14px; font-weight: 500; transition: 0.2s; }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(26,115,232,0.3); }

        .week-nav { display: flex; align-items: center; gap: 15px; font-weight: bold; background: #fff; padding: 5px 15px; border-radius: 8px; border: 1px solid var(--border); }
        .btn-nav { padding: 8px 15px; cursor: pointer; border: none; background: none; color: var(--primary); font-weight: bold; font-size: 16px; }
        .btn-nav:hover { background: #f1f3f4; border-radius: 4px; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; }
        th, td { border: 1px solid var(--border); padding: 12px 5px; text-align: center; font-size: 13px; transition: 0.2s; }
        th { background: #f8f9fa; height: 45px; font-weight: 600; color: #5f6368; }
        .period-col { width: 70px; background: #f1f3f4; font-weight: bold; color: #3c4043; }
        
        /* ìƒíƒœë³„ ìŠ¤íƒ€ì¼ */
        .cell-fixed { background: #f1f3f4; color: #70757a; font-size: 11px; cursor: not-allowed; }
        .cell-booked { background: #e8f0fe; color: var(--primary); font-weight: bold; cursor: pointer; position: relative; }
        .cell-booked:hover::after { content: 'í´ë¦­í•˜ì—¬ ì·¨ì†Œ'; position: absolute; bottom: 2px; left: 0; width: 100%; font-size: 9px; font-weight: normal; color: #666; }
        .cell-empty { background: #e6f4ea; color: #137333; cursor: pointer; font-weight: 500; }
        .cell-empty:hover { background: #d2e3d5; }
        
        .legend { display: flex; gap: 15px; font-size: 12px; margin-top: 15px; justify-content: flex-end; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-header">
        <div>
            <h1 id="roomTitle" style="margin:0; font-size: 24px; color: var(--primary);">ğŸ€ ì²´ìœ¡ê´€ ì£¼ê°„ í˜„í™©</h1>
            <p style="margin: 5px 0 0; font-size: 13px; color: #5f6368;">ì˜¨ë¼ì¸ êµë¬´ì‹¤: íŠ¹ë³„ì‹¤ ì˜ˆì•½ ì‹œìŠ¤í…œ</p>
        </div>
        <div class="week-nav">
            <button class="btn-nav" onclick="changeWeek(-7)">â—€</button>
            <span id="weekRange">ë¡œë”© ì¤‘...</span>
            <button class="btn-nav" onclick="changeWeek(7)">â–¶</button>
        </div>
    </div>

    <div class="room-tabs">
        <div class="tab active" onclick="changeRoom('ì²´ìœ¡ê´€(ë¯¸ì†Œê´€)', this)">ğŸ€ ì²´ìœ¡ê´€</div>
        <div class="tab" onclick="changeRoom('ì»´í“¨í„°ì‹¤', this)">ğŸ’» ì»´í“¨í„°ì‹¤</div>
        <div class="tab" onclick="changeRoom('ê±´ê°•ì²´ë ¥êµì‹¤', this)">ğŸƒ ê±´ê°•ì²´ë ¥</div>
        <div class="tab" onclick="changeRoom('ë…ì„œë‚˜ëˆ”ì‹¤', this)">ğŸ“– ë…ì„œë‚˜ëˆ”</div>
        <div class="tab" onclick="changeRoom('ë¯¸ìˆ ì‹¤', this)">ğŸ¨ ë¯¸ìˆ ì‹¤</div>
    </div>

    <table id="weeklyTable">
        <thead>
            <tr>
                <th class="period-col">êµì‹œ</th>
                <th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="legend">
        <div class="legend-item"><span class="dot" style="background:#f1f3f4"></span>ì •ê·œ ìˆ˜ì—…</div>
        <div class="legend-item"><span class="dot" style="background:#e8f0fe"></span>ì˜ˆì•½ ì™„ë£Œ</div>
        <div class="legend-item"><span class="dot" style="background:#e6f4ea"></span>ì‹ ì²­ ê°€ëŠ¥</div>
    </div>
</div>

<script>
    let currentRoom = 'ì²´ìœ¡ê´€(ë¯¸ì†Œê´€)';
    let baseDate = new Date(); 

    window.onload = loadSchedule;

    function changeRoom(room, el) {
        currentRoom = room;
        document.getElementById('roomTitle').innerText = room + " ì£¼ê°„ í˜„í™©";
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        loadSchedule();
    }

    function changeWeek(days) {
        baseDate.setDate(baseDate.getDate() + days);
        loadSchedule();
    }

    function loadSchedule() {
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="6" style="padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>';
        const dateStr = baseDate.toISOString().split('T')[0];
        google.script.run.withSuccessHandler(renderTable).getWeeklySchedule(dateStr, currentRoom);
    }

    function renderTable(res) {
        const days = ["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ"];
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        document.getElementById('weekRange').innerText = `${res.weekDates[0]} ~ ${res.weekDates[4]}`;

        for (let p = 1; p <= 6; p++) {
            let rowHtml = `<tr><td class="period-col">${p}</td>`;
            res.weekDates.forEach((date, index) => {
                let status = 'ì‹ ì²­';
                let style = 'cell-empty';
                let action = `onclick="openBooking('${date}', ${p})"`;

                // ê³ ì • ì‹œê°„í‘œ ì²´í¬
                const fixed = res.fixedData.find(r => r[1] == days[index] && r[2] == p);
                if(fixed) { status = fixed[3]; style = 'cell-fixed'; action = ''; }

                // ì˜ˆì•½ ë‚´ì—­ ì²´í¬
                const booked = res.resData.find(r => {
                    const d = new Date(r[0]);
                    return date === d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, '0') + "-" + String(d.getDate()).padStart(2, '0') && r[2] == p;
                });
                if(booked) { 
                    status = booked[3]; 
                    style = 'cell-booked'; 
                    action = `onclick="cancelBooking('${date}', ${p}, '${booked[3]}')"`; 
                }

                rowHtml += `<td class="${style}" ${action}>${status}</td>`;
            });
            rowHtml += `</tr>`;
            tbody.innerHTML += rowHtml;
        }
    }

    function openBooking(date, period) {
        const name = prompt(`${date} ${period}êµì‹œ ì˜ˆì•½ì ì„±í•¨:`);
        if(!name) return;
        const purpose = prompt('ì‚¬ìš© ëª©ì :');
        if(!purpose) return;
        const password = prompt('ì·¨ì†Œìš© ë¹„ë°€ë²ˆí˜¸ ì„¤ì •(ìˆ«ì):');
        if(!password) return;
        
        google.script.run.withSuccessHandler(res => {
            alert(res);
            loadSchedule();
        }).submitReservation({date, room: currentRoom, period, name, purpose, password});
    }

    function cancelBooking(date, period, name) {
        if(!confirm(`[${name}] ì„ ìƒë‹˜ì˜ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const password = prompt('ì˜ˆì•½ ì‹œ ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if(!password) return;

        google.script.run.withSuccessHandler(res => {
            alert(res.msg);
            if(res.success) loadSchedule();
        }).deleteReservation({date, room: currentRoom, period, password});
    }
</script>
</body>
</html>
